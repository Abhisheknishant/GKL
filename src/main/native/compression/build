#!/usr/bin/env bash
IGZIP=igzip_042

# build igzip library
cd $IGZIP/igzip
make
cd -

# build otc_zlib
cd otc_zlib
make clean
CFLAGS="-fPIC" ./configure --static
make static
cd -

# build GKL shared library
javah -o IntelDeflater.h -cp ../../java com.intel.gkl.compression.IntelDeflater

os=$(uname)
if [[ $os == "Linux" ]]; then

g++ -z noexecstack -shared -Wl,--whole-archive -fPIC -O3 -I$IGZIP/igzip/c_code/ -I$IGZIP/include \
    -I$JAVA_HOME/include -I$JAVA_HOME/include/linux \
    IntelDeflater.cc $IGZIP/igzip/libigzip0c.a otc_zlib/libz.a -Wl,--no-whole-archive -o libIntelGKL.so

elif [[ $os == "Darwin" ]]; then

g++ -shared -fPIC -O3 -I$IGZIP/igzip/c_code/ -I$IGZIP/include \
    -I$JAVA_HOME/include -I$JAVA_HOME/include/Darwin \
    IntelDeflater.cc $IGZIP/igzip/libigzip0c.a -o libIntelGKL.dylib

else

echo "OS not supported" 1>&2

fi
